<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OpenSourcePOS - Point of Sale Demo</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; }
    
    /* Navigation */
    .navbar { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
    .navbar h1 { font-size: 24px; display: flex; align-items: center; gap: 10px; }
    .nav-links { display: flex; gap: 5px; }
    .nav-links button { background: rgba(255,255,255,0.2); border: none; color: white; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 14px; transition: all 0.3s; }
    .nav-links button:hover, .nav-links button.active { background: rgba(255,255,255,0.4); }
    
    /* Main Layout */
    .main-container { display: flex; height: calc(100vh - 66px); }
    
    /* Sidebar */
    .sidebar { width: 280px; background: white; border-right: 1px solid #e0e0e0; overflow-y: auto; }
    .sidebar-section { padding: 20px; border-bottom: 1px solid #e0e0e0; }
    .sidebar-section h3 { color: #333; margin-bottom: 15px; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; }
    
    /* Content Area */
    .content { flex: 1; padding: 20px; overflow-y: auto; }
    .page { display: none; }
    .page.active { display: block; }
    
    /* Cards */
    .card { background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .card-header h2 { font-size: 18px; color: #333; }
    
    /* Stats Grid */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
    .stat-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    .stat-card .label-icon { font-size: 12px; text-transform: uppercase; color: #999; margin-bottom: 5px; }
    .stat-card .value { font-size: 28px; font-weight: bold; color: #333; }
    .stat-card .label { font-size: 14px; color: #666; margin-top: 5px; }
    .stat-card.green { border-left: 4px solid #4CAF50; }
    .stat-card.blue { border-left: 4px solid #2196F3; }
    .stat-card.orange { border-left: 4px solid #FF9800; }
    .stat-card.purple { border-left: 4px solid #9C27B0; }
    
    /* Product Grid */
    .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
    .product-card { background: white; border-radius: 10px; padding: 15px; text-align: center; cursor: pointer; transition: all 0.3s; border: 2px solid transparent; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    .product-card:hover { transform: translateY(-3px); border-color: #667eea; box-shadow: 0 4px 12px rgba(102,126,234,0.3); }
    .product-card .category-label { font-size: 10px; text-transform: uppercase; color: #999; margin-bottom: 8px; background: #f0f0f0; padding: 3px 8px; border-radius: 4px; display: inline-block; }
    .product-card .name { font-size: 14px; font-weight: 600; color: #333; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .product-card .price { font-size: 16px; color: #667eea; font-weight: bold; }
    .product-card .stock { font-size: 11px; color: #999; margin-top: 5px; }
    .product-card .stock.low { color: #f44336; }
    
    /* Cart */
    .cart { background: white; height: 100%; display: flex; flex-direction: column; }
    .cart-header { padding: 20px; border-bottom: 1px solid #e0e0e0; }
    .cart-header h3 { display: flex; align-items: center; gap: 10px; }
    .cart-items { flex: 1; overflow-y: auto; padding: 10px; }
    .cart-item { display: flex; align-items: center; padding: 12px; border-radius: 8px; margin-bottom: 8px; background: #f8f9fa; }
    .cart-item .info { flex: 1; }
    .cart-item .name { font-weight: 600; font-size: 14px; }
    .cart-item .price { font-size: 12px; color: #666; }
    .cart-item .qty-controls { display: flex; align-items: center; gap: 8px; }
    .cart-item .qty-controls button { width: 28px; height: 28px; border: none; border-radius: 50%; cursor: pointer; font-size: 16px; }
    .cart-item .qty-controls button.minus { background: #ffebee; color: #f44336; }
    .cart-item .qty-controls button.plus { background: #e8f5e9; color: #4CAF50; }
    .cart-item .qty { font-weight: bold; min-width: 30px; text-align: center; }
    .cart-item .subtotal { font-weight: bold; color: #667eea; margin-left: 15px; min-width: 70px; text-align: right; }
    .cart-item .remove { background: none; border: none; color: #f44336; cursor: pointer; font-size: 18px; margin-left: 10px; }
    
    /* Cart Footer */
    .cart-footer { padding: 20px; border-top: 1px solid #e0e0e0; background: #fafafa; }
    .cart-totals { margin-bottom: 15px; }
    .cart-totals .row { display: flex; justify-content: space-between; margin-bottom: 8px; }
    .cart-totals .row.total { font-size: 20px; font-weight: bold; color: #333; padding-top: 10px; border-top: 2px solid #e0e0e0; }
    
    /* Buttons */
    .btn { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
    .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102,126,234,0.4); }
    .btn-success { background: #4CAF50; color: white; }
    .btn-success:hover { background: #43A047; }
    .btn-danger { background: #f44336; color: white; }
    .btn-danger:hover { background: #e53935; }
    .btn-outline { background: white; border: 2px solid #667eea; color: #667eea; }
    .btn-outline:hover { background: #667eea; color: white; }
    .btn-block { width: 100%; }
    .btn-lg { padding: 15px 30px; font-size: 16px; }
    
    /* Forms */
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #333; font-size: 14px; }
    .form-group input, .form-group select { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: border-color 0.3s; }
    .form-group input:focus, .form-group select:focus { outline: none; border-color: #667eea; }
    
    /* Category Pills */
    .category-pills { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; }
    .category-pill { padding: 8px 16px; border-radius: 20px; background: #f0f0f0; border: none; cursor: pointer; font-size: 13px; transition: all 0.3s; }
    .category-pill:hover, .category-pill.active { background: #667eea; color: white; }
    
    /* Search */
    .search-box { position: relative; margin-bottom: 15px; }
    .search-box input { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; }
    
    /* Tables */
    .table { width: 100%; border-collapse: collapse; }
    .table th, .table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #e0e0e0; }
    .table th { background: #f8f9fa; font-weight: 600; color: #333; font-size: 13px; text-transform: uppercase; }
    .table tr:hover { background: #f8f9fa; }
    .badge { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; }
    .badge-success { background: #e8f5e9; color: #4CAF50; }
    .badge-warning { background: #fff3e0; color: #FF9800; }
    .badge-info { background: #e3f2fd; color: #2196F3; }
    
    /* Modal */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
    .modal.active { display: flex; }
    .modal-content { background: white; border-radius: 16px; padding: 30px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .modal-header h2 { font-size: 20px; }
    .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: #999; }
    
    /* Receipt */
    .receipt { font-family: 'Courier New', monospace; background: white; padding: 20px; border: 2px dashed #ccc; max-width: 300px; margin: 0 auto; }
    .receipt-header { text-align: center; border-bottom: 1px dashed #333; padding-bottom: 15px; margin-bottom: 15px; }
    .receipt-header h3 { font-size: 18px; }
    .receipt-items { border-bottom: 1px dashed #333; padding-bottom: 15px; margin-bottom: 15px; }
    .receipt-item { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 12px; }
    .receipt-totals .row { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 3px; }
    .receipt-totals .total { font-weight: bold; font-size: 16px; margin-top: 10px; padding-top: 10px; border-top: 1px dashed #333; }
    .receipt-footer { text-align: center; margin-top: 15px; font-size: 11px; color: #666; }
    
    /* Customer Select */
    .customer-select { margin-bottom: 15px; }
    .customer-select select { width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; }
    
    /* Payment Options */
    .payment-options { display: flex; gap: 10px; margin-bottom: 20px; }
    .payment-option { flex: 1; padding: 15px; border: 2px solid #e0e0e0; border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.3s; }
    .payment-option:hover, .payment-option.active { border-color: #667eea; background: #f0f4ff; }
    .payment-option .icon { font-size: 14px; margin-bottom: 5px; font-weight: bold; }
    
    /* Responsive */
    @media (max-width: 1200px) {
      .main-container { flex-direction: column; }
      .sidebar { width: 100%; max-height: 300px; }
    }

    /* Low stock animation */
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .low-stock { animation: pulse 2s infinite; }

    /* Empty cart */
    .empty-cart { text-align: center; padding: 40px; color: #999; }
    .empty-cart .icon { font-size: 14px; margin-bottom: 15px; font-weight: bold; }

    /* Customer card in table */
    .customer-info { display: flex; align-items: center; gap: 10px; }
    .customer-avatar { width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; }
  </style>
</head>
<body>
  <nav class="navbar">
    <h1>OpenSourcePOS</h1>
    <div class="nav-links">
      <button onclick="showPage('dashboard')" class="active" data-page="dashboard">Dashboard</button>
      <button onclick="showPage('pos')" data-page="pos">Make Sale</button>
      <button onclick="showPage('products')" data-page="products">Products</button>
      <button onclick="showPage('customers')" data-page="customers">Customers</button>
      <button onclick="showPage('sales')" data-page="sales">Sales History</button>
    </div>
  </nav>

  <div class="main-container">
    <!-- DASHBOARD PAGE -->
    <div class="content">
      <div id="dashboard" class="page active">
        <h2 style="margin-bottom: 20px;">Dashboard Overview</h2>
        <div class="stats-grid" id="statsGrid">
          <!-- Stats loaded dynamically -->
        </div>
        <div class="card">
          <div class="card-header">
            <h2>Recent Sales</h2>
          </div>
          <table class="table" id="recentSalesTable">
            <thead>
              <tr><th>Receipt #</th><th>Customer</th><th>Items</th><th>Total</th><th>Time</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- POS PAGE -->
      <div id="pos" class="page">
        <div style="display: flex; gap: 20px; height: calc(100vh - 140px);">
          <!-- Product Selection -->
          <div style="flex: 2; overflow-y: auto;">
            <div class="search-box">
              <input type="text" id="productSearch" placeholder="Search products or scan barcode..." oninput="filterProducts()">
            </div>
            <div class="category-pills" id="categoryPills"></div>
            <div class="products-grid" id="posProducts"></div>
          </div>
          
          <!-- Cart -->
          <div class="cart" style="flex: 1; min-width: 350px;">
            <div class="cart-header">
              <h3>Current Sale</h3>
            </div>
            <div class="customer-select" style="padding: 10px 20px;">
              <select id="cartCustomer" onchange="updateCartCustomer()">
                <option value="">Walk-in Customer</option>
              </select>
            </div>
            <div class="cart-items" id="cartItems">
              <div class="empty-cart">
                <div class="icon">ðŸ›’</div>
                <p>Cart is empty</p>
                <p style="font-size: 12px;">Click products to add them</p>
              </div>
            </div>
            <div class="cart-footer">
              <div class="cart-totals">
                <div class="row"><span>Subtotal:</span><span id="cartSubtotal">$0.00</span></div>
                <div class="row"><span>Tax (8%):</span><span id="cartTax">$0.00</span></div>
                <div class="row total"><span>Total:</span><span id="cartTotal">$0.00</span></div>
              </div>
              <button class="btn btn-primary btn-block btn-lg" onclick="openCheckout()" id="checkoutBtn" disabled>
                Checkout
              </button>
              <button class="btn btn-outline btn-block" onclick="clearCart()" style="margin-top: 10px;">
                Clear Cart
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- PRODUCTS PAGE -->
      <div id="products" class="page">
        <div class="card">
          <div class="card-header">
            <h2>Product Inventory</h2>
            <button class="btn btn-primary" onclick="openAddProductModal()">+ Add Product</button>
          </div>
          <div class="search-box">
            <input type="text" id="inventorySearch" placeholder="Search products..." oninput="filterInventory()">
          </div>
          <table class="table" id="productsTable">
            <thead>
              <tr><th>Product</th><th>Category</th><th>Price</th><th>Stock</th><th>Barcode</th><th>Actions</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- CUSTOMERS PAGE -->
      <div id="customers" class="page">
        <div class="card">
          <div class="card-header">
            <h2>Customer Management</h2>
            <button class="btn btn-primary" onclick="openAddCustomerModal()">+ Add Customer</button>
          </div>
          <table class="table" id="customersTable">
            <thead>
              <tr><th>Customer</th><th>Email</th><th>Phone</th><th>Loyalty Points</th><th>Member Since</th><th>Actions</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- SALES HISTORY PAGE -->
      <div id="sales" class="page">
        <div class="card">
          <div class="card-header">
            <h2>Sales History</h2>
          </div>
          <table class="table" id="salesTable">
            <thead>
              <tr><th>Receipt #</th><th>Customer</th><th>Items</th><th>Subtotal</th><th>Tax</th><th>Total</th><th>Payment</th><th>Date</th><th>Actions</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Checkout Modal -->
  <div class="modal" id="checkoutModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Complete Sale</h2>
        <button class="modal-close" onclick="closeModal('checkoutModal')">&times;</button>
      </div>
      <div class="payment-options">
        <div class="payment-option active" onclick="selectPayment('cash')">
          <div class="icon">CASH</div>
          <div>Cash</div>
        </div>
        <div class="payment-option" onclick="selectPayment('card')">
          <div class="icon">CARD</div>
          <div>Card</div>
        </div>
        <div class="payment-option" onclick="selectPayment('mobile')">
          <div class="icon">MOBILE</div>
          <div>Mobile</div>
        </div>
      </div>
      <div id="cashPaymentSection">
        <div class="form-group">
          <label>Amount Tendered ($)</label>
          <input type="number" id="amountTendered" step="0.01" oninput="calculateChange()">
        </div>
        <div class="form-group">
          <label>Change Due</label>
          <input type="text" id="changeDue" readonly style="background: #f0f0f0; font-weight: bold; font-size: 18px;">
        </div>
      </div>
      <button class="btn btn-success btn-block btn-lg" onclick="completeSale()">
        Complete Sale
      </button>
    </div>
  </div>

  <!-- Receipt Modal -->
  <div class="modal" id="receiptModal">
    <div class="modal-content" style="max-width: 350px;">
      <div class="modal-header">
        <h2>Receipt</h2>
        <button class="modal-close" onclick="closeModal('receiptModal')">&times;</button>
      </div>
      <div class="receipt" id="receiptContent"></div>
      <div style="margin-top: 20px; display: flex; gap: 10px;">
        <button class="btn btn-primary" onclick="printReceipt()" style="flex: 1;">Print</button>
        <button class="btn btn-outline" onclick="closeModal('receiptModal')" style="flex: 1;">Done</button>
      </div>
    </div>
  </div>

  <!-- Add Product Modal -->
  <div class="modal" id="addProductModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Add New Product</h2>
        <button class="modal-close" onclick="closeModal('addProductModal')">&times;</button>
      </div>
      <form onsubmit="addProduct(event)">
        <div class="form-group">
          <label>Product Name</label>
          <input type="text" id="newProductName" required>
        </div>
        <div class="form-group">
          <label>Category</label>
          <select id="newProductCategory" required>
            <option value="Beverages">Beverages</option>
            <option value="Snacks">Snacks</option>
            <option value="Bakery">Bakery</option>
            <option value="Dairy">Dairy</option>
            <option value="Fresh Food">Fresh Food</option>
            <option value="Household">Household</option>
          </select>
        </div>
        <div class="form-group">
          <label>Price ($)</label>
          <input type="number" id="newProductPrice" step="0.01" required>
        </div>
        <div class="form-group">
          <label>Stock Quantity</label>
          <input type="number" id="newProductStock" required>
        </div>
        <div class="form-group">
          <label>Barcode</label>
          <input type="text" id="newProductBarcode">
        </div>
        <button type="submit" class="btn btn-success btn-block">Add Product</button>
      </form>
    </div>
  </div>

  <!-- Add Customer Modal -->
  <div class="modal" id="addCustomerModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Add New Customer</h2>
        <button class="modal-close" onclick="closeModal('addCustomerModal')">&times;</button>
      </div>
      <form onsubmit="addCustomer(event)">
        <div class="form-group">
          <label>Full Name</label>
          <input type="text" id="newCustomerName" required>
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="newCustomerEmail" required>
        </div>
        <div class="form-group">
          <label>Phone</label>
          <input type="tel" id="newCustomerPhone" required>
        </div>
        <div class="form-group">
          <label>Address</label>
          <input type="text" id="newCustomerAddress">
        </div>
        <button type="submit" class="btn btn-success btn-block">Add Customer</button>
      </form>
    </div>
  </div>

  <script>
    // State
    let products = [];
    let customers = [];
    let sales = [];
    let cart = [];
    let selectedCategory = 'All';
    let selectedPayment = 'cash';
    let selectedCustomerId = null;

    // API calls
    const api = {
      get: async (url) => (await fetch('/api' + url)).json(),
      post: async (url, data) => (await fetch('/api' + url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) })).json(),
    };

    // Initialize
    async function init() {
      await Promise.all([loadProducts(), loadCustomers(), loadSales(), loadStats()]);
      renderCategories();
      renderPosProducts();
      renderProductsTable();
      renderCustomersTable();
      renderSalesTable();
      renderCustomerSelect();
    }

    // Data loading
    async function loadProducts() { products = await api.get('/products'); }
    async function loadCustomers() { customers = await api.get('/customers'); }
    async function loadSales() { sales = await api.get('/sales'); }
    async function loadStats() {
      const stats = await api.get('/stats');
      document.getElementById('statsGrid').innerHTML = `
        <div class="stat-card green">
          <div class="label-icon">SALES</div>
          <div class="value">$${stats.todaySales}</div>
          <div class="label">Today's Sales</div>
        </div>
        <div class="stat-card blue">
          <div class="label-icon">TRANSACTIONS</div>
          <div class="value">${stats.todayTransactions}</div>
          <div class="label">Today's Transactions</div>
        </div>
        <div class="stat-card purple">
          <div class="label-icon">PRODUCTS</div>
          <div class="value">${stats.totalProducts}</div>
          <div class="label">Total Products</div>
        </div>
        <div class="stat-card orange">
          <div class="label-icon">ALERT</div>
          <div class="value">${stats.lowStockItems}</div>
          <div class="label">Low Stock Items</div>
        </div>
      `;
      // Recent sales
      const tbody = document.querySelector('#recentSalesTable tbody');
      tbody.innerHTML = sales.slice(0, 5).map(s => `
        <tr>
          <td><strong>${s.receiptNumber}</strong></td>
          <td>${s.customerName}</td>
          <td>${s.items.length} items</td>
          <td><strong>$${s.total.toFixed(2)}</strong></td>
          <td>${new Date(s.timestamp).toLocaleTimeString()}</td>
        </tr>
      `).join('') || '<tr><td colspan="5" style="text-align:center;color:#999;">No sales yet</td></tr>';
    }

    // Navigation
    function showPage(page) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById(page).classList.add('active');
      document.querySelectorAll('.nav-links button').forEach(b => b.classList.remove('active'));
      document.querySelector(`[data-page="${page}"]`).classList.add('active');
      if (page === 'dashboard') loadStats();
      if (page === 'sales') { loadSales(); renderSalesTable(); }
    }

    // Categories
    function renderCategories() {
      const cats = ['All', ...new Set(products.map(p => p.category))];
      document.getElementById('categoryPills').innerHTML = cats.map(c => 
        `<button class="category-pill ${c === selectedCategory ? 'active' : ''}" onclick="selectCategory('${c}')">${c}</button>`
      ).join('');
    }

    function selectCategory(cat) {
      selectedCategory = cat;
      renderCategories();
      renderPosProducts();
    }

    // POS Products Grid
    function renderPosProducts() {
      const search = document.getElementById('productSearch')?.value.toLowerCase() || '';
      const filtered = products.filter(p => {
        const matchCat = selectedCategory === 'All' || p.category === selectedCategory;
        const matchSearch = p.name.toLowerCase().includes(search) || p.barcode?.includes(search);
        return matchCat && matchSearch;
      });
      document.getElementById('posProducts').innerHTML = filtered.map(p => `
        <div class="product-card" onclick="addToCart(${p.id})">
          <div class="category-label">${p.category}</div>
          <div class="name" title="${p.name}">${p.name}</div>
          <div class="price">$${p.price.toFixed(2)}</div>
          <div class="stock ${p.stock < 20 ? 'low' : ''}">Stock: ${p.stock}</div>
        </div>
      `).join('');
    }

    function filterProducts() { renderPosProducts(); }

    // Cart
    function addToCart(productId) {
      const product = products.find(p => p.id === productId);
      if (!product || product.stock <= 0) return alert('Product out of stock!');
      
      const existing = cart.find(c => c.productId === productId);
      if (existing) {
        if (existing.quantity >= product.stock) return alert('Not enough stock!');
        existing.quantity++;
      } else {
        cart.push({ productId, name: product.name, price: product.price, quantity: 1 });
      }
      renderCart();
    }

    function updateQuantity(productId, delta) {
      const item = cart.find(c => c.productId === productId);
      const product = products.find(p => p.id === productId);
      if (!item) return;
      
      item.quantity += delta;
      if (item.quantity <= 0) {
        cart = cart.filter(c => c.productId !== productId);
      } else if (item.quantity > product.stock) {
        item.quantity = product.stock;
        alert('Not enough stock!');
      }
      renderCart();
    }

    function removeFromCart(productId) {
      cart = cart.filter(c => c.productId !== productId);
      renderCart();
    }

    function clearCart() {
      cart = [];
      renderCart();
    }

    function renderCart() {
      const container = document.getElementById('cartItems');
      if (cart.length === 0) {
        container.innerHTML = `<div class="empty-cart"><div class="icon">EMPTY</div><p>Cart is empty</p><p style="font-size: 12px;">Click products to add them</p></div>`;
        document.getElementById('cartSubtotal').textContent = '$0.00';
        document.getElementById('cartTax').textContent = '$0.00';
        document.getElementById('cartTotal').textContent = '$0.00';
        document.getElementById('checkoutBtn').disabled = true;
        return;
      }

      container.innerHTML = cart.map(item => `
        <div class="cart-item">
          <div class="info">
            <div class="name">${item.name}</div>
            <div class="price">$${item.price.toFixed(2)} each</div>
          </div>
          <div class="qty-controls">
            <button class="minus" onclick="updateQuantity(${item.productId}, -1)">âˆ’</button>
            <span class="qty">${item.quantity}</span>
            <button class="plus" onclick="updateQuantity(${item.productId}, 1)">+</button>
          </div>
          <div class="subtotal">$${(item.price * item.quantity).toFixed(2)}</div>
          <button class="remove" onclick="removeFromCart(${item.productId})">Ã—</button>
        </div>
      `).join('');

      const subtotal = cart.reduce((sum, i) => sum + i.price * i.quantity, 0);
      const tax = subtotal * 0.08;
      const total = subtotal + tax;

      document.getElementById('cartSubtotal').textContent = '$' + subtotal.toFixed(2);
      document.getElementById('cartTax').textContent = '$' + tax.toFixed(2);
      document.getElementById('cartTotal').textContent = '$' + total.toFixed(2);
      document.getElementById('checkoutBtn').disabled = false;
    }

    // Checkout
    function openCheckout() {
      if (cart.length === 0) return;
      const total = cart.reduce((sum, i) => sum + i.price * i.quantity, 0) * 1.08;
      document.getElementById('amountTendered').value = total.toFixed(2);
      document.getElementById('changeDue').value = '$0.00';
      document.getElementById('checkoutModal').classList.add('active');
    }

    function selectPayment(method) {
      selectedPayment = method;
      document.querySelectorAll('.payment-option').forEach(p => p.classList.remove('active'));
      event.target.closest('.payment-option').classList.add('active');
      document.getElementById('cashPaymentSection').style.display = method === 'cash' ? 'block' : 'none';
    }

    function calculateChange() {
      const total = cart.reduce((sum, i) => sum + i.price * i.quantity, 0) * 1.08;
      const tendered = parseFloat(document.getElementById('amountTendered').value) || 0;
      const change = tendered - total;
      document.getElementById('changeDue').value = change >= 0 ? '$' + change.toFixed(2) : 'Insufficient';
    }

    async function completeSale() {
      const total = cart.reduce((sum, i) => sum + i.price * i.quantity, 0) * 1.08;
      const tendered = parseFloat(document.getElementById('amountTendered').value) || total;
      
      if (selectedPayment === 'cash' && tendered < total) {
        return alert('Insufficient payment amount!');
      }

      const sale = await api.post('/sales', {
        items: cart.map(c => ({ productId: c.productId, quantity: c.quantity })),
        customerId: selectedCustomerId,
        paymentMethod: selectedPayment,
        amountTendered: tendered
      });

      closeModal('checkoutModal');
      showReceipt(sale);
      cart = [];
      renderCart();
      await loadProducts();
      renderPosProducts();
    }

    function showReceipt(sale) {
      document.getElementById('receiptContent').innerHTML = `
        <div class="receipt-header">
          <h3>OpenSourcePOS</h3>
          <div>Demo Store Location</div>
          <div style="margin-top: 10px;">Receipt #: ${sale.receiptNumber}</div>
          <div>${new Date(sale.timestamp).toLocaleString()}</div>
        </div>
        <div class="receipt-items">
          ${sale.items.map(i => `
            <div class="receipt-item">
              <span>${i.quantity}x ${i.name}</span>
              <span>$${i.subtotal.toFixed(2)}</span>
            </div>
          `).join('')}
        </div>
        <div class="receipt-totals">
          <div class="row"><span>Subtotal:</span><span>$${sale.subtotal.toFixed(2)}</span></div>
          <div class="row"><span>Tax (8%):</span><span>$${sale.tax.toFixed(2)}</span></div>
          <div class="row total"><span>TOTAL:</span><span>$${sale.total.toFixed(2)}</span></div>
          <div class="row"><span>Paid (${sale.paymentMethod}):</span><span>$${sale.amountTendered.toFixed(2)}</span></div>
          ${sale.change > 0 ? `<div class="row"><span>Change:</span><span>$${sale.change.toFixed(2)}</span></div>` : ''}
        </div>
        <div class="receipt-footer">
          <div>Customer: ${sale.customerName}</div>
          <div>Cashier: ${sale.cashier}</div>
          <div style="margin-top: 10px;">Thank you for your purchase!</div>
        </div>
      `;
      document.getElementById('receiptModal').classList.add('active');
    }

    function printReceipt() {
      window.print();
    }

    // Customer Select
    function renderCustomerSelect() {
      const select = document.getElementById('cartCustomer');
      select.innerHTML = '<option value="">Walk-in Customer</option>' + 
        customers.map(c => `<option value="${c.id}">${c.name} (${c.loyaltyPoints} pts)</option>`).join('');
    }

    function updateCartCustomer() {
      selectedCustomerId = parseInt(document.getElementById('cartCustomer').value) || null;
    }

    // Products Table
    function renderProductsTable() {
      const search = document.getElementById('inventorySearch')?.value.toLowerCase() || '';
      const filtered = products.filter(p => p.name.toLowerCase().includes(search));
      document.querySelector('#productsTable tbody').innerHTML = filtered.map(p => `
        <tr>
          <td><strong>${p.name}</strong></td>
          <td><span class="badge badge-info">${p.category}</span></td>
          <td><strong>$${p.price.toFixed(2)}</strong></td>
          <td><span class="badge ${p.stock < 20 ? 'badge-warning' : 'badge-success'}">${p.stock} units</span></td>
          <td>${p.barcode || '-'}</td>
          <td><button class="btn btn-outline" style="padding: 5px 10px; font-size: 12px;">Edit</button></td>
        </tr>
      `).join('');
    }

    function filterInventory() { renderProductsTable(); }

    // Customers Table
    function renderCustomersTable() {
      document.querySelector('#customersTable tbody').innerHTML = customers.map(c => `
        <tr>
          <td>
            <div class="customer-info">
              <div class="customer-avatar">${c.name.charAt(0)}</div>
              <div>
                <strong>${c.name}</strong>
                <div style="font-size: 12px; color: #666;">${c.address || ''}</div>
              </div>
            </div>
          </td>
          <td>${c.email}</td>
          <td>${c.phone}</td>
          <td><span class="badge badge-success">${c.loyaltyPoints} pts</span></td>
          <td>${c.memberSince}</td>
          <td><button class="btn btn-outline" style="padding: 5px 10px; font-size: 12px;">View</button></td>
        </tr>
      `).join('');
    }

    // Sales Table
    function renderSalesTable() {
      document.querySelector('#salesTable tbody').innerHTML = sales.map(s => `
        <tr>
          <td><strong>${s.receiptNumber}</strong></td>
          <td>${s.customerName}</td>
          <td>${s.items.length} items</td>
          <td>$${s.subtotal.toFixed(2)}</td>
          <td>$${s.tax.toFixed(2)}</td>
          <td><strong>$${s.total.toFixed(2)}</strong></td>
          <td><span class="badge badge-info">${s.paymentMethod}</span></td>
          <td>${new Date(s.timestamp).toLocaleString()}</td>
          <td><button class="btn btn-outline" style="padding: 5px 10px; font-size: 12px;" onclick='showReceipt(${JSON.stringify(s)})'>View</button></td>
        </tr>
      `).join('') || '<tr><td colspan="9" style="text-align:center;color:#999;">No sales recorded yet</td></tr>';
    }

    // Add Product
    function openAddProductModal() {
      document.getElementById('addProductModal').classList.add('active');
    }

    async function addProduct(e) {
      e.preventDefault();
      const product = {
        name: document.getElementById('newProductName').value,
        category: document.getElementById('newProductCategory').value,
        price: parseFloat(document.getElementById('newProductPrice').value),
        stock: parseInt(document.getElementById('newProductStock').value),
        barcode: document.getElementById('newProductBarcode').value
      };
      await api.post('/products', product);
      closeModal('addProductModal');
      e.target.reset();
      await loadProducts();
      renderProductsTable();
      renderPosProducts();
      renderCategories();
    }

    // Add Customer
    function openAddCustomerModal() {
      document.getElementById('addCustomerModal').classList.add('active');
    }

    async function addCustomer(e) {
      e.preventDefault();
      const customer = {
        name: document.getElementById('newCustomerName').value,
        email: document.getElementById('newCustomerEmail').value,
        phone: document.getElementById('newCustomerPhone').value,
        address: document.getElementById('newCustomerAddress').value
      };
      await api.post('/customers', customer);
      closeModal('addCustomerModal');
      e.target.reset();
      await loadCustomers();
      renderCustomersTable();
      renderCustomerSelect();
    }

    // Modal
    function closeModal(id) {
      document.getElementById(id).classList.remove('active');
    }

    // Start app
    init();
  </script>
</body>
</html>
