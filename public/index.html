<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OpenSourcePOS - Point of Sale</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; color: #000; }
    
    /* BLACK AND WHITE THEME */
    .navbar { background: #000; color: #fff; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; }
    .navbar h1 { font-size: 24px; }
    .nav-links { display: flex; gap: 5px; }
    .nav-links button { background: #333; border: 1px solid #555; color: #fff; padding: 10px 20px; cursor: pointer; font-size: 14px; transition: all 0.2s; }
    .nav-links button:hover, .nav-links button.active { background: #fff; color: #000; }
    .user-info { display: flex; align-items: center; gap: 15px; }
    .user-info span { font-size: 14px; }
    .logout-btn { background: #333; border: 1px solid #555; color: #fff; padding: 8px 16px; cursor: pointer; }
    .logout-btn:hover { background: #fff; color: #000; }
    
    /* LOGIN PAGE */
    .login-page { display: flex; align-items: center; justify-content: center; min-height: 100vh; background: #000; }
    .login-box { background: #fff; padding: 40px; width: 400px; border: 2px solid #000; }
    .login-box h1 { text-align: center; margin-bottom: 10px; font-size: 28px; }
    .login-box .subtitle { text-align: center; color: #666; margin-bottom: 30px; }
    .login-tabs { display: flex; margin-bottom: 20px; }
    .login-tabs button { flex: 1; padding: 12px; border: 2px solid #000; background: #fff; cursor: pointer; font-weight: bold; }
    .login-tabs button.active { background: #000; color: #fff; }
    .login-tabs button:first-child { border-right: none; }
    
    /* FORMS */
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px; }
    .form-group input, .form-group select { width: 100%; padding: 12px; border: 2px solid #000; font-size: 14px; background: #fff; }
    .form-group input:focus, .form-group select:focus { outline: none; background: #f5f5f5; }
    .error-msg { color: #000; background: #ddd; padding: 10px; margin-bottom: 15px; border: 1px solid #000; text-align: center; }
    
    /* BUTTONS */
    .btn { padding: 12px 24px; border: 2px solid #000; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s; }
    .btn-primary { background: #000; color: #fff; }
    .btn-primary:hover { background: #333; }
    .btn-secondary { background: #fff; color: #000; }
    .btn-secondary:hover { background: #f0f0f0; }
    .btn-block { width: 100%; }
    .btn-lg { padding: 15px 30px; font-size: 16px; }
    
    /* MAIN LAYOUT */
    .main-container { padding: 20px; }
    .page { display: none; }
    .page.active { display: block; }
    
    /* CARDS */
    .card { background: #fff; border: 2px solid #000; padding: 20px; margin-bottom: 20px; }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #ddd; }
    .card-header h2 { font-size: 18px; }
    
    /* STATS GRID */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
    .stat-card { background: #fff; border: 2px solid #000; padding: 20px; }
    .stat-card .value { font-size: 32px; font-weight: bold; }
    .stat-card .label { font-size: 14px; color: #666; margin-top: 5px; text-transform: uppercase; }
    
    /* PRODUCT GRID */
    .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
    .product-card { background: #fff; border: 2px solid #000; padding: 15px; text-align: center; cursor: pointer; transition: all 0.2s; }
    .product-card:hover { background: #000; color: #fff; }
    .product-card .category { font-size: 10px; text-transform: uppercase; color: #666; margin-bottom: 8px; padding: 3px 8px; background: #f0f0f0; display: inline-block; }
    .product-card:hover .category { background: #333; color: #fff; }
    .product-card .name { font-size: 14px; font-weight: 600; margin-bottom: 5px; }
    .product-card .price { font-size: 16px; font-weight: bold; }
    .product-card .stock { font-size: 11px; color: #666; margin-top: 5px; }
    .product-card:hover .stock { color: #ccc; }
    
    /* CART */
    .cart { background: #fff; border: 2px solid #000; height: 100%; display: flex; flex-direction: column; }
    .cart-header { padding: 20px; border-bottom: 2px solid #000; }
    .cart-header h3 { font-size: 18px; }
    .cart-items { flex: 1; overflow-y: auto; padding: 10px; }
    .cart-item { display: flex; align-items: center; padding: 12px; border: 1px solid #ddd; margin-bottom: 8px; background: #f9f9f9; }
    .cart-item .info { flex: 1; }
    .cart-item .name { font-weight: 600; font-size: 14px; }
    .cart-item .price { font-size: 12px; color: #666; }
    .cart-item .qty-controls { display: flex; align-items: center; gap: 8px; }
    .cart-item .qty-controls button { width: 28px; height: 28px; border: 1px solid #000; background: #fff; cursor: pointer; font-size: 16px; }
    .cart-item .qty-controls button:hover { background: #000; color: #fff; }
    .cart-item .qty { font-weight: bold; min-width: 30px; text-align: center; }
    .cart-item .subtotal { font-weight: bold; margin-left: 15px; min-width: 70px; text-align: right; }
    .cart-item .remove { background: none; border: none; cursor: pointer; font-size: 18px; margin-left: 10px; }
    
    /* CART FOOTER */
    .cart-footer { padding: 20px; border-top: 2px solid #000; background: #f5f5f5; }
    .cart-totals { margin-bottom: 15px; }
    .cart-totals .row { display: flex; justify-content: space-between; margin-bottom: 8px; }
    .cart-totals .row.total { font-size: 20px; font-weight: bold; padding-top: 10px; border-top: 2px solid #000; }
    
    /* CUSTOMER SELECT */
    .customer-select { padding: 10px 20px; border-bottom: 1px solid #ddd; }
    .customer-select select { width: 100%; padding: 10px; border: 2px solid #000; }
    
    /* CATEGORY PILLS */
    .category-pills { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; }
    .category-pill { padding: 8px 16px; border: 2px solid #000; background: #fff; cursor: pointer; font-size: 13px; }
    .category-pill:hover, .category-pill.active { background: #000; color: #fff; }
    
    /* SEARCH */
    .search-box { margin-bottom: 15px; }
    .search-box input { width: 100%; padding: 12px; border: 2px solid #000; font-size: 14px; }
    
    /* TABLES */
    .table { width: 100%; border-collapse: collapse; }
    .table th, .table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd; }
    .table th { background: #000; color: #fff; font-weight: 600; font-size: 13px; text-transform: uppercase; }
    .table tr:hover { background: #f5f5f5; }
    .badge { display: inline-block; padding: 4px 10px; font-size: 12px; font-weight: 600; border: 1px solid #000; }
    
    /* MODAL */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center; }
    .modal.active { display: flex; }
    .modal-content { background: #fff; border: 2px solid #000; padding: 30px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #000; }
    .modal-header h2 { font-size: 20px; }
    .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; }
    
    /* RECEIPT */
    .receipt { font-family: 'Courier New', monospace; background: #fff; padding: 20px; border: 2px dashed #000; max-width: 300px; margin: 0 auto; }
    .receipt-header { text-align: center; border-bottom: 1px dashed #000; padding-bottom: 15px; margin-bottom: 15px; }
    .receipt-header h3 { font-size: 18px; }
    .receipt-items { border-bottom: 1px dashed #000; padding-bottom: 15px; margin-bottom: 15px; }
    .receipt-item { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 12px; }
    .receipt-totals .row { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 3px; }
    .receipt-totals .total { font-weight: bold; font-size: 16px; margin-top: 10px; padding-top: 10px; border-top: 1px dashed #000; }
    .receipt-footer { text-align: center; margin-top: 15px; font-size: 11px; color: #666; }
    
    /* PAYMENT OPTIONS */
    .payment-options { display: flex; gap: 10px; margin-bottom: 20px; }
    .payment-option { flex: 1; padding: 15px; border: 2px solid #000; text-align: center; cursor: pointer; transition: all 0.2s; }
    .payment-option:hover, .payment-option.active { background: #000; color: #fff; }
    .payment-option .label { font-weight: bold; }
    
    /* EMPTY STATE */
    .empty-state { text-align: center; padding: 40px; color: #666; }
    
    /* CUSTOMER DASHBOARD */
    .customer-profile { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; }
    .profile-card { text-align: center; }
    .profile-avatar { width: 100px; height: 100px; background: #000; color: #fff; font-size: 48px; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px; }
    .profile-name { font-size: 24px; font-weight: bold; margin-bottom: 5px; }
    .profile-email { color: #666; margin-bottom: 15px; }
    .points-display { background: #000; color: #fff; padding: 20px; margin-top: 20px; }
    .points-display .value { font-size: 36px; font-weight: bold; }
    .points-display .label { font-size: 12px; text-transform: uppercase; }

    /* RESPONSIVE */
    @media (max-width: 1200px) {
      .customer-profile { grid-template-columns: 1fr; }
    }
    
    /* HIDDEN */
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <!-- LOGIN PAGE -->
  <div id="loginPage" class="login-page">
    <div class="login-box">
      <h1>OpenSourcePOS</h1>
      <p class="subtitle">Point of Sale System</p>
      
      <div class="login-tabs">
        <button class="active" onclick="switchLoginTab('login')">Sign In</button>
        <button onclick="switchLoginTab('register')">Register</button>
      </div>
      
      <div id="loginError" class="error-msg hidden"></div>
      
      <!-- LOGIN FORM -->
      <form id="loginForm" onsubmit="handleLogin(event)">
        <div class="form-group">
          <label>Username</label>
          <input type="text" id="loginUsername" required placeholder="Enter username">
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="loginPassword" required placeholder="Enter password">
        </div>
        <button type="submit" class="btn btn-primary btn-block btn-lg">Sign In</button>
      </form>
      
      <!-- REGISTER FORM -->
      <form id="registerForm" class="hidden" onsubmit="handleRegister(event)">
        <div class="form-group">
          <label>Full Name</label>
          <input type="text" id="regName" required placeholder="Enter your full name">
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="regEmail" required placeholder="Enter your email">
        </div>
        <div class="form-group">
          <label>Username</label>
          <input type="text" id="regUsername" required placeholder="Choose a username">
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="regPassword" required placeholder="Choose a password">
        </div>
        <div class="form-group">
          <label>Phone (Optional)</label>
          <input type="tel" id="regPhone" placeholder="Enter phone number">
        </div>
        <button type="submit" class="btn btn-primary btn-block btn-lg">Create Account</button>
      </form>
      
      <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #ddd; font-size: 12px; color: #666;">
        <strong>Demo Accounts:</strong><br>
        Cashier: cashier1 / cash123<br>
        Customer: sarah.j / cust123
      </div>
    </div>
  </div>

  <!-- MAIN APP (HIDDEN UNTIL LOGIN) -->
  <div id="mainApp" class="hidden">
    <!-- NAVBAR -->
    <nav class="navbar">
      <h1>OpenSourcePOS</h1>
      <div class="nav-links" id="navLinks">
        <!-- Dynamic based on role -->
      </div>
      <div class="user-info">
        <span id="userDisplay"></span>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>
    </nav>

    <!-- MAIN CONTENT -->
    <div class="main-container">
      
      <!-- ============ CASHIER PAGES ============ -->
      
      <!-- CASHIER DASHBOARD -->
      <div id="cashierDashboard" class="page">
        <h2 style="margin-bottom: 20px;">Cashier Dashboard</h2>
        <div class="stats-grid" id="statsGrid"></div>
        <div class="card">
          <div class="card-header">
            <h2>Recent Sales</h2>
          </div>
          <table class="table" id="recentSalesTable">
            <thead>
              <tr><th>Receipt #</th><th>Customer</th><th>Items</th><th>Total</th><th>Time</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- POS PAGE (CASHIER) -->
      <div id="pos" class="page">
        <div style="display: flex; gap: 20px; height: calc(100vh - 140px);">
          <div style="flex: 2; overflow-y: auto;">
            <div class="search-box">
              <input type="text" id="productSearch" placeholder="Search products or scan barcode..." oninput="filterProducts()">
            </div>
            <div class="category-pills" id="categoryPills"></div>
            <div class="products-grid" id="posProducts"></div>
          </div>
          <div class="cart" style="flex: 1; min-width: 350px;">
            <div class="cart-header">
              <h3>Current Sale</h3>
            </div>
            <div class="customer-select">
              <select id="cartCustomer" onchange="updateCartCustomer()">
                <option value="">Walk-in Customer</option>
              </select>
            </div>
            <div class="cart-items" id="cartItems">
              <div class="empty-state">
                <p>Cart is empty</p>
                <p style="font-size: 12px;">Click products to add them</p>
              </div>
            </div>
            <div class="cart-footer">
              <div class="cart-totals">
                <div class="row"><span>Subtotal:</span><span id="cartSubtotal">$0.00</span></div>
                <div class="row"><span>Tax (8%):</span><span id="cartTax">$0.00</span></div>
                <div class="row total"><span>Total:</span><span id="cartTotal">$0.00</span></div>
              </div>
              <button class="btn btn-primary btn-block btn-lg" onclick="openCheckout()" id="checkoutBtn" disabled>Checkout</button>
              <button class="btn btn-secondary btn-block" onclick="clearCart()" style="margin-top: 10px;">Clear Cart</button>
            </div>
          </div>
        </div>
      </div>

      <!-- PRODUCTS PAGE (CASHIER) -->
      <div id="products" class="page">
        <div class="card">
          <div class="card-header">
            <h2>Product Inventory</h2>
            <button class="btn btn-primary" onclick="openAddProductModal()">+ Add Product</button>
          </div>
          <div class="search-box">
            <input type="text" id="inventorySearch" placeholder="Search products..." oninput="filterInventory()">
          </div>
          <table class="table" id="productsTable">
            <thead>
              <tr><th>Product</th><th>Category</th><th>Price</th><th>Stock</th><th>Barcode</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- CUSTOMERS PAGE (CASHIER) -->
      <div id="customers" class="page">
        <div class="card">
          <div class="card-header">
            <h2>Customer Management</h2>
          </div>
          <table class="table" id="customersTable">
            <thead>
              <tr><th>Customer</th><th>Email</th><th>Phone</th><th>Loyalty Points</th><th>Member Since</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- SALES HISTORY (CASHIER) -->
      <div id="sales" class="page">
        <div class="card">
          <div class="card-header">
            <h2>Sales History</h2>
          </div>
          <table class="table" id="salesTable">
            <thead>
              <tr><th>Receipt #</th><th>Customer</th><th>Items</th><th>Total</th><th>Payment</th><th>Date</th><th>Actions</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- ============ CUSTOMER PAGES ============ -->
      
      <!-- CUSTOMER DASHBOARD -->
      <div id="customerDashboard" class="page">
        <div class="customer-profile">
          <div class="card profile-card">
            <div class="profile-avatar" id="profileAvatar">S</div>
            <div class="profile-name" id="profileName">Customer Name</div>
            <div class="profile-email" id="profileEmail">email@example.com</div>
            <div class="points-display">
              <div class="value" id="profilePoints">0</div>
              <div class="label">Loyalty Points</div>
            </div>
          </div>
          <div>
            <div class="card">
              <div class="card-header">
                <h2>Account Overview</h2>
              </div>
              <div class="stats-grid" id="customerStatsGrid"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- CUSTOMER ORDER HISTORY -->
      <div id="customerOrders" class="page">
        <div class="card">
          <div class="card-header">
            <h2>My Order History</h2>
          </div>
          <table class="table" id="customerOrdersTable">
            <thead>
              <tr><th>Receipt #</th><th>Items</th><th>Total</th><th>Date</th><th>Actions</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- CUSTOMER PROFILE SETTINGS -->
      <div id="customerProfile" class="page">
        <div class="card" style="max-width: 600px;">
          <div class="card-header">
            <h2>My Profile</h2>
          </div>
          <form onsubmit="updateProfile(event)">
            <div class="form-group">
              <label>Full Name</label>
              <input type="text" id="editName">
            </div>
            <div class="form-group">
              <label>Email</label>
              <input type="email" id="editEmail">
            </div>
            <div class="form-group">
              <label>Phone</label>
              <input type="tel" id="editPhone">
            </div>
            <div class="form-group">
              <label>Address</label>
              <input type="text" id="editAddress">
            </div>
            <button type="submit" class="btn btn-primary">Save Changes</button>
          </form>
        </div>
      </div>

      <!-- BROWSE PRODUCTS (CUSTOMER) -->
      <div id="browseProducts" class="page">
        <div class="card">
          <div class="card-header">
            <h2>Browse Products</h2>
          </div>
          <div class="search-box">
            <input type="text" id="browseSearch" placeholder="Search products..." oninput="filterBrowseProducts()">
          </div>
          <div class="category-pills" id="browseCategoryPills"></div>
          <div class="products-grid" id="browseProductsGrid"></div>
        </div>
      </div>

    </div>
  </div>

  <!-- CHECKOUT MODAL -->
  <div class="modal" id="checkoutModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Complete Sale</h2>
        <button class="modal-close" onclick="closeModal('checkoutModal')">&times;</button>
      </div>
      <div class="payment-options">
        <div class="payment-option active" onclick="selectPayment('cash')">
          <div class="label">CASH</div>
        </div>
        <div class="payment-option" onclick="selectPayment('card')">
          <div class="label">CARD</div>
        </div>
        <div class="payment-option" onclick="selectPayment('mobile')">
          <div class="label">MOBILE</div>
        </div>
      </div>
      <div id="cashPaymentSection">
        <div class="form-group">
          <label>Amount Tendered ($)</label>
          <input type="number" id="amountTendered" step="0.01" oninput="calculateChange()">
        </div>
        <div class="form-group">
          <label>Change Due</label>
          <input type="text" id="changeDue" readonly style="background: #f0f0f0; font-weight: bold; font-size: 18px;">
        </div>
      </div>
      <button class="btn btn-primary btn-block btn-lg" onclick="completeSale()">Complete Sale</button>
    </div>
  </div>

  <!-- RECEIPT MODAL -->
  <div class="modal" id="receiptModal">
    <div class="modal-content" style="max-width: 350px;">
      <div class="modal-header">
        <h2>Receipt</h2>
        <button class="modal-close" onclick="closeModal('receiptModal')">&times;</button>
      </div>
      <div class="receipt" id="receiptContent"></div>
      <div style="margin-top: 20px; display: flex; gap: 10px;">
        <button class="btn btn-primary" onclick="printReceipt()" style="flex: 1;">Print</button>
        <button class="btn btn-secondary" onclick="closeModal('receiptModal')" style="flex: 1;">Done</button>
      </div>
    </div>
  </div>

  <!-- ADD PRODUCT MODAL -->
  <div class="modal" id="addProductModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Add New Product</h2>
        <button class="modal-close" onclick="closeModal('addProductModal')">&times;</button>
      </div>
      <form onsubmit="addProduct(event)">
        <div class="form-group">
          <label>Product Name</label>
          <input type="text" id="newProductName" required>
        </div>
        <div class="form-group">
          <label>Category</label>
          <select id="newProductCategory" required>
            <option value="Beverages">Beverages</option>
            <option value="Snacks">Snacks</option>
            <option value="Bakery">Bakery</option>
            <option value="Dairy">Dairy</option>
            <option value="Fresh Food">Fresh Food</option>
            <option value="Household">Household</option>
          </select>
        </div>
        <div class="form-group">
          <label>Price ($)</label>
          <input type="number" id="newProductPrice" step="0.01" required>
        </div>
        <div class="form-group">
          <label>Stock Quantity</label>
          <input type="number" id="newProductStock" required>
        </div>
        <div class="form-group">
          <label>Barcode</label>
          <input type="text" id="newProductBarcode">
        </div>
        <button type="submit" class="btn btn-primary btn-block">Add Product</button>
      </form>
    </div>
  </div>

  <script>
    // ========== STATE ==========
    let currentUser = null;
    let products = [];
    let customers = [];
    let sales = [];
    let cart = [];
    let selectedCategory = 'All';
    let selectedPayment = 'cash';
    let selectedCustomerId = null;

    // ========== API ==========
    const api = {
      get: async (url) => (await fetch('/api' + url)).json(),
      post: async (url, data) => {
        const res = await fetch('/api' + url, { 
          method: 'POST', 
          headers: { 'Content-Type': 'application/json' }, 
          body: JSON.stringify(data) 
        });
        return res.json();
      },
      put: async (url, data) => {
        const res = await fetch('/api' + url, { 
          method: 'PUT', 
          headers: { 'Content-Type': 'application/json' }, 
          body: JSON.stringify(data) 
        });
        return res.json();
      }
    };

    // ========== AUTH ==========
    function switchLoginTab(tab) {
      document.querySelectorAll('.login-tabs button').forEach(b => b.classList.remove('active'));
      event.target.classList.add('active');
      document.getElementById('loginForm').classList.toggle('hidden', tab !== 'login');
      document.getElementById('registerForm').classList.toggle('hidden', tab !== 'register');
      document.getElementById('loginError').classList.add('hidden');
    }

    async function handleLogin(e) {
      e.preventDefault();
      const username = document.getElementById('loginUsername').value;
      const password = document.getElementById('loginPassword').value;
      
      try {
        const result = await api.post('/login', { username, password });
        if (result.success) {
          currentUser = result.user;
          localStorage.setItem('user', JSON.stringify(currentUser));
          showApp();
        } else {
          showLoginError(result.error || 'Login failed');
        }
      } catch (err) {
        showLoginError('Login failed. Please try again.');
      }
    }

    async function handleRegister(e) {
      e.preventDefault();
      const data = {
        name: document.getElementById('regName').value,
        email: document.getElementById('regEmail').value,
        username: document.getElementById('regUsername').value,
        password: document.getElementById('regPassword').value,
        phone: document.getElementById('regPhone').value,
        role: 'customer'
      };
      
      try {
        const result = await api.post('/register', data);
        if (result.success) {
          currentUser = result.user;
          localStorage.setItem('user', JSON.stringify(currentUser));
          showApp();
        } else {
          showLoginError(result.error || 'Registration failed');
        }
      } catch (err) {
        showLoginError('Registration failed. Please try again.');
      }
    }

    function showLoginError(msg) {
      const el = document.getElementById('loginError');
      el.textContent = msg;
      el.classList.remove('hidden');
    }

    function logout() {
      currentUser = null;
      localStorage.removeItem('user');
      document.getElementById('loginPage').classList.remove('hidden');
      document.getElementById('mainApp').classList.add('hidden');
      document.getElementById('loginUsername').value = '';
      document.getElementById('loginPassword').value = '';
    }

    // ========== APP INIT ==========
    function showApp() {
      document.getElementById('loginPage').classList.add('hidden');
      document.getElementById('mainApp').classList.remove('hidden');
      document.getElementById('userDisplay').textContent = `${currentUser.name} (${currentUser.role})`;
      
      setupNavigation();
      loadData();
    }

    function setupNavigation() {
      const navLinks = document.getElementById('navLinks');
      
      if (currentUser.role === 'cashier') {
        navLinks.innerHTML = `
          <button class="active" data-page="cashierDashboard" onclick="showPage('cashierDashboard')">Dashboard</button>
          <button data-page="pos" onclick="showPage('pos')">Make Sale</button>
          <button data-page="products" onclick="showPage('products')">Products</button>
          <button data-page="customers" onclick="showPage('customers')">Customers</button>
          <button data-page="sales" onclick="showPage('sales')">Sales History</button>
        `;
        showPage('cashierDashboard');
      } else {
        navLinks.innerHTML = `
          <button class="active" data-page="customerDashboard" onclick="showPage('customerDashboard')">My Account</button>
          <button data-page="customerOrders" onclick="showPage('customerOrders')">Order History</button>
          <button data-page="browseProducts" onclick="showPage('browseProducts')">Browse Products</button>
          <button data-page="customerProfile" onclick="showPage('customerProfile')">Profile Settings</button>
        `;
        showPage('customerDashboard');
      }
    }

    async function loadData() {
      products = await api.get('/products');
      
      if (currentUser.role === 'cashier') {
        customers = await api.get('/customers');
        sales = await api.get('/sales');
        await loadCashierStats();
        renderCategories();
        renderPosProducts();
        renderProductsTable();
        renderCustomersTable();
        renderSalesTable();
        renderCustomerSelect();
      } else {
        await loadCustomerDashboard();
        renderBrowseCategories();
        renderBrowseProducts();
      }
    }

    // ========== NAVIGATION ==========
    function showPage(page) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById(page).classList.add('active');
      document.querySelectorAll('.nav-links button').forEach(b => b.classList.remove('active'));
      document.querySelector(`[data-page="${page}"]`)?.classList.add('active');
      
      if (page === 'cashierDashboard') loadCashierStats();
      if (page === 'sales') { loadSales(); renderSalesTable(); }
      if (page === 'customerDashboard') loadCustomerDashboard();
      if (page === 'customerOrders') loadCustomerOrders();
      if (page === 'customerProfile') loadProfileForm();
    }

    // ========== CASHIER FUNCTIONS ==========
    async function loadCashierStats() {
      const stats = await api.get('/stats');
      document.getElementById('statsGrid').innerHTML = `
        <div class="stat-card">
          <div class="value">$${stats.todaySales}</div>
          <div class="label">Today's Sales</div>
        </div>
        <div class="stat-card">
          <div class="value">${stats.todayTransactions}</div>
          <div class="label">Transactions Today</div>
        </div>
        <div class="stat-card">
          <div class="value">${stats.totalProducts}</div>
          <div class="label">Total Products</div>
        </div>
        <div class="stat-card">
          <div class="value">${stats.lowStockItems}</div>
          <div class="label">Low Stock Items</div>
        </div>
      `;
      
      const tbody = document.querySelector('#recentSalesTable tbody');
      tbody.innerHTML = sales.slice(0, 5).map(s => `
        <tr>
          <td><strong>${s.receiptNumber}</strong></td>
          <td>${s.customerName}</td>
          <td>${s.items.length} items</td>
          <td><strong>$${s.total.toFixed(2)}</strong></td>
          <td>${new Date(s.timestamp).toLocaleTimeString()}</td>
        </tr>
      `).join('') || '<tr><td colspan="5" style="text-align:center;color:#666;">No sales yet</td></tr>';
    }

    async function loadSales() {
      sales = await api.get('/sales');
    }

    function renderCategories() {
      const cats = ['All', ...new Set(products.map(p => p.category))];
      document.getElementById('categoryPills').innerHTML = cats.map(c => 
        `<button class="category-pill ${c === selectedCategory ? 'active' : ''}" onclick="selectCategory('${c}')">${c}</button>`
      ).join('');
    }

    function selectCategory(cat) {
      selectedCategory = cat;
      renderCategories();
      renderPosProducts();
    }

    function renderPosProducts() {
      const search = document.getElementById('productSearch')?.value.toLowerCase() || '';
      const filtered = products.filter(p => {
        const matchCat = selectedCategory === 'All' || p.category === selectedCategory;
        const matchSearch = p.name.toLowerCase().includes(search) || p.barcode?.includes(search);
        return matchCat && matchSearch;
      });
      document.getElementById('posProducts').innerHTML = filtered.map(p => `
        <div class="product-card" onclick="addToCart(${p.id})">
          <div class="category">${p.category}</div>
          <div class="name">${p.name}</div>
          <div class="price">$${p.price.toFixed(2)}</div>
          <div class="stock">Stock: ${p.stock}</div>
        </div>
      `).join('');
    }

    function filterProducts() { renderPosProducts(); }

    function addToCart(productId) {
      const product = products.find(p => p.id === productId);
      if (!product || product.stock <= 0) return alert('Product out of stock!');
      
      const existing = cart.find(c => c.productId === productId);
      if (existing) {
        if (existing.quantity >= product.stock) return alert('Not enough stock!');
        existing.quantity++;
      } else {
        cart.push({ productId, name: product.name, price: product.price, quantity: 1 });
      }
      renderCart();
    }

    function updateQuantity(productId, delta) {
      const item = cart.find(c => c.productId === productId);
      const product = products.find(p => p.id === productId);
      if (!item) return;
      
      item.quantity += delta;
      if (item.quantity <= 0) {
        cart = cart.filter(c => c.productId !== productId);
      } else if (item.quantity > product.stock) {
        item.quantity = product.stock;
        alert('Not enough stock!');
      }
      renderCart();
    }

    function removeFromCart(productId) {
      cart = cart.filter(c => c.productId !== productId);
      renderCart();
    }

    function clearCart() {
      cart = [];
      renderCart();
    }

    function renderCart() {
      const container = document.getElementById('cartItems');
      if (cart.length === 0) {
        container.innerHTML = `<div class="empty-state"><p>Cart is empty</p><p style="font-size: 12px;">Click products to add them</p></div>`;
        document.getElementById('cartSubtotal').textContent = '$0.00';
        document.getElementById('cartTax').textContent = '$0.00';
        document.getElementById('cartTotal').textContent = '$0.00';
        document.getElementById('checkoutBtn').disabled = true;
        return;
      }

      container.innerHTML = cart.map(item => `
        <div class="cart-item">
          <div class="info">
            <div class="name">${item.name}</div>
            <div class="price">$${item.price.toFixed(2)} each</div>
          </div>
          <div class="qty-controls">
            <button onclick="updateQuantity(${item.productId}, -1)">-</button>
            <span class="qty">${item.quantity}</span>
            <button onclick="updateQuantity(${item.productId}, 1)">+</button>
          </div>
          <div class="subtotal">$${(item.price * item.quantity).toFixed(2)}</div>
          <button class="remove" onclick="removeFromCart(${item.productId})">x</button>
        </div>
      `).join('');

      const subtotal = cart.reduce((sum, i) => sum + i.price * i.quantity, 0);
      const tax = subtotal * 0.08;
      const total = subtotal + tax;

      document.getElementById('cartSubtotal').textContent = '$' + subtotal.toFixed(2);
      document.getElementById('cartTax').textContent = '$' + tax.toFixed(2);
      document.getElementById('cartTotal').textContent = '$' + total.toFixed(2);
      document.getElementById('checkoutBtn').disabled = false;
    }

    function openCheckout() {
      if (cart.length === 0) return;
      const total = cart.reduce((sum, i) => sum + i.price * i.quantity, 0) * 1.08;
      document.getElementById('amountTendered').value = total.toFixed(2);
      document.getElementById('changeDue').value = '$0.00';
      document.getElementById('checkoutModal').classList.add('active');
    }

    function selectPayment(method) {
      selectedPayment = method;
      document.querySelectorAll('.payment-option').forEach(p => p.classList.remove('active'));
      event.target.closest('.payment-option').classList.add('active');
      document.getElementById('cashPaymentSection').style.display = method === 'cash' ? 'block' : 'none';
    }

    function calculateChange() {
      const total = cart.reduce((sum, i) => sum + i.price * i.quantity, 0) * 1.08;
      const tendered = parseFloat(document.getElementById('amountTendered').value) || 0;
      const change = tendered - total;
      document.getElementById('changeDue').value = change >= 0 ? '$' + change.toFixed(2) : 'Insufficient';
    }

    async function completeSale() {
      const total = cart.reduce((sum, i) => sum + i.price * i.quantity, 0) * 1.08;
      const tendered = parseFloat(document.getElementById('amountTendered').value) || total;
      
      if (selectedPayment === 'cash' && tendered < total) {
        return alert('Insufficient payment amount!');
      }

      const sale = await api.post('/sales', {
        items: cart.map(c => ({ productId: c.productId, quantity: c.quantity })),
        customerId: selectedCustomerId,
        paymentMethod: selectedPayment,
        amountTendered: tendered,
        cashierId: currentUser.id,
        cashierName: currentUser.name
      });

      closeModal('checkoutModal');
      showReceipt(sale);
      cart = [];
      renderCart();
      products = await api.get('/products');
      renderPosProducts();
    }

    function showReceipt(sale) {
      document.getElementById('receiptContent').innerHTML = `
        <div class="receipt-header">
          <h3>OpenSourcePOS</h3>
          <div>Store Location</div>
          <div style="margin-top: 10px;">Receipt #: ${sale.receiptNumber}</div>
          <div>${new Date(sale.timestamp).toLocaleString()}</div>
        </div>
        <div class="receipt-items">
          ${sale.items.map(i => `
            <div class="receipt-item">
              <span>${i.quantity}x ${i.name}</span>
              <span>$${i.subtotal.toFixed(2)}</span>
            </div>
          `).join('')}
        </div>
        <div class="receipt-totals">
          <div class="row"><span>Subtotal:</span><span>$${sale.subtotal.toFixed(2)}</span></div>
          <div class="row"><span>Tax (8%):</span><span>$${sale.tax.toFixed(2)}</span></div>
          <div class="row total"><span>TOTAL:</span><span>$${sale.total.toFixed(2)}</span></div>
          <div class="row"><span>Paid (${sale.paymentMethod}):</span><span>$${sale.amountTendered.toFixed(2)}</span></div>
          ${sale.change > 0 ? `<div class="row"><span>Change:</span><span>$${sale.change.toFixed(2)}</span></div>` : ''}
        </div>
        <div class="receipt-footer">
          <div>Customer: ${sale.customerName}</div>
          <div>Cashier: ${sale.cashier}</div>
          <div style="margin-top: 10px;">Thank you for your purchase!</div>
        </div>
      `;
      document.getElementById('receiptModal').classList.add('active');
    }

    function printReceipt() { window.print(); }

    function renderCustomerSelect() {
      const select = document.getElementById('cartCustomer');
      select.innerHTML = '<option value="">Walk-in Customer</option>' + 
        customers.map(c => `<option value="${c.id}">${c.name} (${c.loyaltyPoints} pts)</option>`).join('');
    }

    function updateCartCustomer() {
      selectedCustomerId = parseInt(document.getElementById('cartCustomer').value) || null;
    }

    function renderProductsTable() {
      const search = document.getElementById('inventorySearch')?.value.toLowerCase() || '';
      const filtered = products.filter(p => p.name.toLowerCase().includes(search));
      document.querySelector('#productsTable tbody').innerHTML = filtered.map(p => `
        <tr>
          <td><strong>${p.name}</strong></td>
          <td><span class="badge">${p.category}</span></td>
          <td><strong>$${p.price.toFixed(2)}</strong></td>
          <td>${p.stock} units</td>
          <td>${p.barcode || '-'}</td>
        </tr>
      `).join('');
    }

    function filterInventory() { renderProductsTable(); }

    function renderCustomersTable() {
      document.querySelector('#customersTable tbody').innerHTML = customers.map(c => `
        <tr>
          <td><strong>${c.name}</strong></td>
          <td>${c.email}</td>
          <td>${c.phone}</td>
          <td>${c.loyaltyPoints} pts</td>
          <td>${c.memberSince}</td>
        </tr>
      `).join('');
    }

    function renderSalesTable() {
      document.querySelector('#salesTable tbody').innerHTML = sales.map(s => `
        <tr>
          <td><strong>${s.receiptNumber}</strong></td>
          <td>${s.customerName}</td>
          <td>${s.items.length} items</td>
          <td><strong>$${s.total.toFixed(2)}</strong></td>
          <td>${s.paymentMethod}</td>
          <td>${new Date(s.timestamp).toLocaleString()}</td>
          <td><button class="btn btn-secondary" style="padding: 5px 10px; font-size: 12px;" onclick='showReceipt(${JSON.stringify(s)})'>View</button></td>
        </tr>
      `).join('') || '<tr><td colspan="7" style="text-align:center;color:#666;">No sales recorded yet</td></tr>';
    }

    function openAddProductModal() {
      document.getElementById('addProductModal').classList.add('active');
    }

    async function addProduct(e) {
      e.preventDefault();
      const product = {
        name: document.getElementById('newProductName').value,
        category: document.getElementById('newProductCategory').value,
        price: parseFloat(document.getElementById('newProductPrice').value),
        stock: parseInt(document.getElementById('newProductStock').value),
        barcode: document.getElementById('newProductBarcode').value
      };
      await api.post('/products', product);
      closeModal('addProductModal');
      e.target.reset();
      products = await api.get('/products');
      renderProductsTable();
      renderPosProducts();
      renderCategories();
    }

    // ========== CUSTOMER FUNCTIONS ==========
    async function loadCustomerDashboard() {
      const customerId = currentUser.customerId;
      const stats = await api.get(`/stats/customer/${customerId}`);
      
      document.getElementById('profileAvatar').textContent = currentUser.name.charAt(0);
      document.getElementById('profileName').textContent = currentUser.name;
      document.getElementById('profileEmail').textContent = currentUser.email;
      document.getElementById('profilePoints').textContent = stats.loyaltyPoints;
      
      document.getElementById('customerStatsGrid').innerHTML = `
        <div class="stat-card">
          <div class="value">${stats.totalOrders}</div>
          <div class="label">Total Orders</div>
        </div>
        <div class="stat-card">
          <div class="value">$${stats.totalSpent}</div>
          <div class="label">Total Spent</div>
        </div>
        <div class="stat-card">
          <div class="value">${stats.loyaltyPoints}</div>
          <div class="label">Loyalty Points</div>
        </div>
      `;
    }

    async function loadCustomerOrders() {
      const customerId = currentUser.customerId;
      const orders = await api.get(`/sales?customerId=${customerId}`);
      
      document.querySelector('#customerOrdersTable tbody').innerHTML = orders.map(s => `
        <tr>
          <td><strong>${s.receiptNumber}</strong></td>
          <td>${s.items.length} items</td>
          <td><strong>$${s.total.toFixed(2)}</strong></td>
          <td>${new Date(s.timestamp).toLocaleString()}</td>
          <td><button class="btn btn-secondary" style="padding: 5px 10px; font-size: 12px;" onclick='showReceipt(${JSON.stringify(s)})'>View</button></td>
        </tr>
      `).join('') || '<tr><td colspan="5" style="text-align:center;color:#666;">No orders yet</td></tr>';
    }

    function loadProfileForm() {
      const customer = currentUser.customerData;
      if (customer) {
        document.getElementById('editName').value = customer.name || '';
        document.getElementById('editEmail').value = customer.email || '';
        document.getElementById('editPhone').value = customer.phone || '';
        document.getElementById('editAddress').value = customer.address || '';
      }
    }

    async function updateProfile(e) {
      e.preventDefault();
      const customerId = currentUser.customerId;
      const data = {
        name: document.getElementById('editName').value,
        email: document.getElementById('editEmail').value,
        phone: document.getElementById('editPhone').value,
        address: document.getElementById('editAddress').value
      };
      
      await api.put(`/customers/${customerId}`, data);
      currentUser.customerData = { ...currentUser.customerData, ...data };
      currentUser.name = data.name;
      currentUser.email = data.email;
      localStorage.setItem('user', JSON.stringify(currentUser));
      document.getElementById('userDisplay').textContent = `${currentUser.name} (${currentUser.role})`;
      alert('Profile updated successfully!');
    }

    function renderBrowseCategories() {
      const cats = ['All', ...new Set(products.map(p => p.category))];
      document.getElementById('browseCategoryPills').innerHTML = cats.map(c => 
        `<button class="category-pill ${c === selectedCategory ? 'active' : ''}" onclick="selectBrowseCategory('${c}')">${c}</button>`
      ).join('');
    }

    function selectBrowseCategory(cat) {
      selectedCategory = cat;
      renderBrowseCategories();
      renderBrowseProducts();
    }

    function renderBrowseProducts() {
      const search = document.getElementById('browseSearch')?.value.toLowerCase() || '';
      const filtered = products.filter(p => {
        const matchCat = selectedCategory === 'All' || p.category === selectedCategory;
        const matchSearch = p.name.toLowerCase().includes(search);
        return matchCat && matchSearch;
      });
      document.getElementById('browseProductsGrid').innerHTML = filtered.map(p => `
        <div class="product-card">
          <div class="category">${p.category}</div>
          <div class="name">${p.name}</div>
          <div class="price">$${p.price.toFixed(2)}</div>
          <div class="stock">${p.stock > 0 ? 'In Stock' : 'Out of Stock'}</div>
        </div>
      `).join('');
    }

    function filterBrowseProducts() { renderBrowseProducts(); }

    // ========== MODAL ==========
    function closeModal(id) {
      document.getElementById(id).classList.remove('active');
    }

    // ========== INIT ==========
    function init() {
      const savedUser = localStorage.getItem('user');
      if (savedUser) {
        currentUser = JSON.parse(savedUser);
        showApp();
      }
    }

    init();
  </script>
</body>
</html>
