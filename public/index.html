<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Self-Service POS - Kiosk</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f0f0; color: #333; }
    
    /* GREY & WHITE THEME */
    :root {
      --bg-dark: #2d2d2d;
      --bg-medium: #404040;
      --bg-light: #666;
      --bg-white: #fff;
      --bg-grey: #f5f5f5;
      --text-dark: #222;
      --text-light: #fff;
      --text-grey: #666;
      --border: #ccc;
      --border-dark: #999;
    }

    /* WELCOME SCREEN */
    .welcome-screen {
      min-height: 100vh;
      background: linear-gradient(135deg, #2d2d2d 0%, #404040 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #fff;
      text-align: center;
      padding: 40px;
    }
    .welcome-screen h1 { font-size: 48px; margin-bottom: 10px; }
    .welcome-screen .subtitle { font-size: 20px; color: #ccc; margin-bottom: 50px; }
    .welcome-options { display: flex; gap: 30px; flex-wrap: wrap; justify-content: center; }
    .welcome-option {
      background: #fff;
      color: #333;
      padding: 40px 50px;
      width: 280px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      border: none;
      text-align: center;
    }
    .welcome-option:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
    .welcome-option h2 { font-size: 24px; margin-bottom: 10px; }
    .welcome-option p { color: #666; font-size: 14px; }

    /* LOGIN MODAL */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal-overlay.active { display: flex; }
    .modal-box {
      background: #fff;
      padding: 40px;
      width: 400px;
      max-width: 95%;
    }
    .modal-box h2 { margin-bottom: 20px; text-align: center; }
    .modal-close {
      position: absolute;
      top: 15px; right: 20px;
      font-size: 30px;
      cursor: pointer;
      color: #fff;
    }

    /* FORMS */
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #555; }
    .form-group input, .form-group select {
      width: 100%;
      padding: 14px;
      border: 2px solid #ddd;
      font-size: 16px;
      background: #f9f9f9;
    }
    .form-group input:focus { outline: none; border-color: #666; background: #fff; }
    .error-msg { background: #f0f0f0; color: #333; padding: 12px; margin-bottom: 15px; border-left: 4px solid #666; }

    /* BUTTONS */
    .btn {
      padding: 14px 28px;
      border: none;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.2s;
    }
    .btn-dark { background: #2d2d2d; color: #fff; }
    .btn-dark:hover { background: #404040; }
    .btn-light { background: #f0f0f0; color: #333; border: 2px solid #ccc; }
    .btn-light:hover { background: #e0e0e0; }
    .btn-block { width: 100%; }
    .btn-lg { padding: 18px 36px; font-size: 18px; }

    /* MAIN APP */
    .main-app { display: none; min-height: 100vh; }
    .main-app.active { display: block; }

    /* HEADER */
    .header {
      background: #2d2d2d;
      color: #fff;
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header h1 { font-size: 22px; }
    .header-right { display: flex; align-items: center; gap: 20px; }
    .header-user { font-size: 14px; color: #ccc; }
    .header-btn {
      background: #404040;
      border: 1px solid #555;
      color: #fff;
      padding: 10px 20px;
      cursor: pointer;
      font-size: 14px;
    }
    .header-btn:hover { background: #555; }

    /* KIOSK LAYOUT */
    .kiosk-container {
      display: flex;
      height: calc(100vh - 60px);
    }
    .products-section {
      flex: 2;
      padding: 20px;
      overflow-y: auto;
      background: #f5f5f5;
    }
    .cart-section {
      flex: 1;
      min-width: 380px;
      background: #fff;
      display: flex;
      flex-direction: column;
      border-left: 2px solid #ddd;
    }

    /* SEARCH & CATEGORIES */
    .search-bar {
      margin-bottom: 20px;
    }
    .search-bar input {
      width: 100%;
      padding: 16px 20px;
      font-size: 18px;
      border: 2px solid #ccc;
      background: #fff;
    }
    .search-bar input:focus { outline: none; border-color: #666; }
    .search-bar input::placeholder { color: #999; }

    .categories {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    .category-btn {
      padding: 12px 24px;
      background: #fff;
      border: 2px solid #ccc;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: #555;
    }
    .category-btn:hover { border-color: #666; }
    .category-btn.active { background: #2d2d2d; color: #fff; border-color: #2d2d2d; }

    /* PRODUCT GRID */
    .products-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 15px;
    }
    .product-card {
      background: #fff;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      border: 2px solid #eee;
      transition: all 0.2s;
    }
    .product-card:hover { border-color: #666; transform: translateY(-3px); }
    .product-card .category-tag {
      font-size: 11px;
      color: #888;
      text-transform: uppercase;
      margin-bottom: 10px;
      padding: 3px 10px;
      background: #f5f5f5;
      display: inline-block;
    }
    .product-card .name { font-size: 15px; font-weight: 600; margin-bottom: 8px; color: #333; }
    .product-card .price { font-size: 20px; font-weight: bold; color: #2d2d2d; }
    .product-card .stock { font-size: 12px; color: #888; margin-top: 8px; }
    .product-card.out-of-stock { opacity: 0.5; pointer-events: none; }

    /* CART */
    .cart-header {
      padding: 20px;
      border-bottom: 2px solid #eee;
      background: #fafafa;
    }
    .cart-header h2 { font-size: 20px; color: #333; }
    .cart-items {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
    }
    .cart-empty {
      text-align: center;
      padding: 50px 20px;
      color: #999;
    }
    .cart-empty p { margin-bottom: 10px; }
    .cart-item {
      display: flex;
      align-items: center;
      padding: 15px;
      border: 1px solid #eee;
      margin-bottom: 10px;
      background: #fafafa;
    }
    .cart-item-info { flex: 1; }
    .cart-item-name { font-weight: 600; color: #333; margin-bottom: 3px; }
    .cart-item-price { font-size: 13px; color: #666; }
    .cart-item-qty {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .qty-btn {
      width: 36px;
      height: 36px;
      border: 2px solid #ccc;
      background: #fff;
      cursor: pointer;
      font-size: 20px;
      font-weight: bold;
    }
    .qty-btn:hover { background: #f0f0f0; border-color: #999; }
    .qty-value { font-weight: bold; min-width: 30px; text-align: center; font-size: 18px; }
    .cart-item-subtotal { font-weight: bold; font-size: 16px; min-width: 80px; text-align: right; margin-left: 15px; }
    .cart-item-remove {
      margin-left: 10px;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 24px;
      color: #999;
    }
    .cart-item-remove:hover { color: #333; }

    /* CART FOOTER */
    .cart-footer {
      padding: 20px;
      border-top: 2px solid #eee;
      background: #fafafa;
    }
    .cart-totals { margin-bottom: 20px; }
    .cart-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      font-size: 15px;
      color: #555;
    }
    .cart-row.total {
      font-size: 24px;
      font-weight: bold;
      color: #2d2d2d;
      padding-top: 15px;
      border-top: 2px solid #ddd;
      margin-top: 15px;
    }

    /* CHECKOUT SCREEN */
    .checkout-screen {
      display: none;
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: #f5f5f5;
      z-index: 500;
      overflow-y: auto;
    }
    .checkout-screen.active { display: block; }
    .checkout-container {
      max-width: 600px;
      margin: 0 auto;
      padding: 40px 20px;
    }
    .checkout-header {
      text-align: center;
      margin-bottom: 30px;
    }
    .checkout-header h1 { font-size: 32px; color: #2d2d2d; }
    .checkout-card {
      background: #fff;
      padding: 30px;
      margin-bottom: 20px;
      border: 2px solid #ddd;
    }
    .checkout-card h3 {
      font-size: 18px;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #eee;
      color: #333;
    }
    .order-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #f0f0f0;
      font-size: 15px;
    }
    .order-item:last-child { border-bottom: none; }
    .order-total {
      display: flex;
      justify-content: space-between;
      font-size: 22px;
      font-weight: bold;
      padding-top: 15px;
      margin-top: 15px;
      border-top: 2px solid #ddd;
    }

    /* PAYMENT OPTIONS */
    .payment-methods {
      display: flex;
      gap: 15px;
    }
    .payment-method {
      flex: 1;
      padding: 25px 20px;
      text-align: center;
      border: 3px solid #ddd;
      background: #fff;
      cursor: pointer;
      transition: all 0.2s;
    }
    .payment-method:hover { border-color: #999; }
    .payment-method.selected { border-color: #2d2d2d; background: #f5f5f5; }
    .payment-method .label { font-weight: bold; font-size: 16px; }
    .payment-method .desc { font-size: 12px; color: #888; margin-top: 5px; }

    /* RECEIPT SCREEN */
    .receipt-screen {
      display: none;
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: #2d2d2d;
      z-index: 600;
      align-items: center;
      justify-content: center;
    }
    .receipt-screen.active { display: flex; }
    .receipt-box {
      background: #fff;
      width: 400px;
      max-width: 95%;
      max-height: 90vh;
      overflow-y: auto;
    }
    .receipt-paper {
      padding: 30px;
      font-family: 'Courier New', monospace;
    }
    .receipt-header {
      text-align: center;
      border-bottom: 2px dashed #ccc;
      padding-bottom: 20px;
      margin-bottom: 20px;
    }
    .receipt-header h2 { font-size: 22px; margin-bottom: 5px; }
    .receipt-header .store-info { font-size: 12px; color: #666; }
    .receipt-meta { font-size: 12px; margin-top: 15px; }
    .receipt-items { margin-bottom: 20px; }
    .receipt-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      font-size: 13px;
    }
    .receipt-summary {
      border-top: 2px dashed #ccc;
      padding-top: 15px;
    }
    .receipt-row {
      display: flex;
      justify-content: space-between;
      padding: 5px 0;
      font-size: 14px;
    }
    .receipt-row.total {
      font-size: 20px;
      font-weight: bold;
      padding-top: 10px;
      margin-top: 10px;
      border-top: 2px solid #333;
    }
    .receipt-footer {
      text-align: center;
      margin-top: 25px;
      padding-top: 20px;
      border-top: 2px dashed #ccc;
      font-size: 13px;
      color: #666;
    }
    .receipt-actions {
      padding: 20px;
      display: flex;
      gap: 15px;
      background: #f5f5f5;
      border-top: 1px solid #ddd;
    }
    .receipt-actions button { flex: 1; }

    /* ADMIN DASHBOARD */
    .admin-nav {
      background: #404040;
      padding: 10px 30px;
      display: flex;
      gap: 5px;
    }
    .admin-nav button {
      background: transparent;
      border: none;
      color: #ccc;
      padding: 12px 24px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
    }
    .admin-nav button:hover { background: #555; color: #fff; }
    .admin-nav button.active { background: #f5f5f5; color: #333; }
    .admin-content {
      padding: 30px;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .stat-box {
      background: #fff;
      padding: 25px;
      border: 2px solid #ddd;
    }
    .stat-box .value { font-size: 36px; font-weight: bold; color: #2d2d2d; }
    .stat-box .label { font-size: 14px; color: #888; margin-top: 5px; text-transform: uppercase; }
    .data-table {
      width: 100%;
      background: #fff;
      border-collapse: collapse;
    }
    .data-table th, .data-table td {
      padding: 15px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    .data-table th {
      background: #2d2d2d;
      color: #fff;
      font-size: 13px;
      text-transform: uppercase;
    }
    .data-table tr:hover { background: #f9f9f9; }

    .hidden { display: none !important; }
  </style>
</head>
<body>
  <!-- WELCOME SCREEN -->
  <div id="welcomeScreen" class="welcome-screen">
    <h1>Self-Service POS</h1>
    <p class="subtitle">Welcome to our store. How would you like to proceed?</p>
    
    <div class="welcome-options">
      <button class="welcome-option" onclick="startGuest()">
        <h2>Quick Checkout</h2>
        <p>Shop as guest, scan items, pay and go</p>
      </button>
      
      <button class="welcome-option" onclick="openLoginModal('customer')">
        <h2>Member Login</h2>
        <p>Sign in for loyalty points and order history</p>
      </button>
      
      <button class="welcome-option" onclick="openLoginModal('admin')">
        <h2>Staff Access</h2>
        <p>Admin dashboard and inventory management</p>
      </button>
    </div>
    
    <p style="margin-top: 50px; color: #888; font-size: 14px;">
      Touch screen to begin | All prices in South African Rands (R) | VAT Included
    </p>
  </div>

  <!-- LOGIN MODAL -->
  <div id="loginModal" class="modal-overlay">
    <span class="modal-close" onclick="closeLoginModal()">&times;</span>
    <div class="modal-box">
      <h2 id="loginTitle">Sign In</h2>
      <div id="loginError" class="error-msg hidden"></div>
      <form onsubmit="handleLogin(event)">
        <div class="form-group">
          <label>Username</label>
          <input type="text" id="loginUsername" required placeholder="Enter username">
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="loginPassword" required placeholder="Enter password">
        </div>
        <button type="submit" class="btn btn-dark btn-block btn-lg">Sign In</button>
      </form>
      <div id="registerLink" style="margin-top: 20px; text-align: center;">
        <p style="color: #888;">Don't have an account?</p>
        <button class="btn btn-light btn-block" style="margin-top: 10px;" onclick="showRegister()">Create Account</button>
      </div>
      <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; font-size: 12px; color: #888; text-align: center;">
        <strong>Demo:</strong> admin / admin123 | sarah.j / cust123
      </div>
    </div>
  </div>

  <!-- REGISTER MODAL -->
  <div id="registerModal" class="modal-overlay">
    <span class="modal-close" onclick="closeRegisterModal()">&times;</span>
    <div class="modal-box">
      <h2>Create Account</h2>
      <div id="registerError" class="error-msg hidden"></div>
      <form onsubmit="handleRegister(event)">
        <div class="form-group">
          <label>Full Name</label>
          <input type="text" id="regName" required>
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="regEmail" required>
        </div>
        <div class="form-group">
          <label>Username</label>
          <input type="text" id="regUsername" required>
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="regPassword" required>
        </div>
        <div class="form-group">
          <label>Phone (Optional)</label>
          <input type="tel" id="regPhone">
        </div>
        <button type="submit" class="btn btn-dark btn-block btn-lg">Create Account</button>
      </form>
      <button class="btn btn-light btn-block" style="margin-top: 15px;" onclick="backToLogin()">Back to Login</button>
    </div>
  </div>

  <!-- MAIN KIOSK APP -->
  <div id="kioskApp" class="main-app">
    <header class="header">
      <h1>Self-Service Checkout</h1>
      <div class="header-right">
        <span class="header-user" id="userDisplay">Guest</span>
        <button class="header-btn" onclick="logout()">Exit</button>
      </div>
    </header>

    <div class="kiosk-container">
      <div class="products-section">
        <div class="search-bar">
          <input type="text" id="searchInput" placeholder="Search products or scan barcode..." oninput="filterProducts()">
        </div>
        <div class="categories" id="categoriesContainer"></div>
        <div class="products-grid" id="productsGrid"></div>
      </div>

      <div class="cart-section">
        <div class="cart-header">
          <h2>Your Cart</h2>
        </div>
        <div class="cart-items" id="cartItems">
          <div class="cart-empty">
            <p>Your cart is empty</p>
            <p style="font-size: 13px;">Tap products to add them</p>
          </div>
        </div>
        <div class="cart-footer">
          <div class="cart-totals">
            <div class="cart-row"><span>Subtotal:</span><span id="cartSubtotal">R0.00</span></div>
            <div class="cart-row"><span>VAT (15%):</span><span id="cartTax">R0.00</span></div>
            <div class="cart-row total"><span>TOTAL:</span><span id="cartTotal">R0.00</span></div>
          </div>
          <button class="btn btn-dark btn-block btn-lg" id="checkoutBtn" onclick="goToCheckout()" disabled>
            Proceed to Payment
          </button>
          <button class="btn btn-light btn-block" onclick="clearCart()" style="margin-top: 10px;">Clear Cart</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ADMIN APP -->
  <div id="adminApp" class="main-app">
    <header class="header">
      <h1>Admin Dashboard</h1>
      <div class="header-right">
        <span class="header-user" id="adminUserDisplay">Admin</span>
        <button class="header-btn" onclick="logout()">Logout</button>
      </div>
    </header>
    <nav class="admin-nav" id="adminNav">
      <button class="active" onclick="showAdminTab('dashboard')">Dashboard</button>
      <button onclick="showAdminTab('sales')">Sales History</button>
      <button onclick="showAdminTab('products')">Products</button>
      <button onclick="showAdminTab('customers')">Customers</button>
    </nav>
    <div class="admin-content" id="adminContent"></div>
  </div>

  <!-- CHECKOUT SCREEN -->
  <div id="checkoutScreen" class="checkout-screen">
    <div class="checkout-container">
      <div class="checkout-header">
        <h1>Checkout</h1>
        <p style="color: #888;">Review your order and select payment method</p>
      </div>

      <div class="checkout-card">
        <h3>Order Summary</h3>
        <div id="checkoutItems"></div>
        <div class="order-total">
          <span>Total to Pay:</span>
          <span id="checkoutTotal">R0.00</span>
        </div>
      </div>

      <div class="checkout-card">
        <h3>Payment Method</h3>
        <div class="payment-methods">
          <div class="payment-method selected" onclick="selectPayment('card')">
            <div class="label">CARD</div>
            <div class="desc">Tap to pay</div>
          </div>
          <div class="payment-method" onclick="selectPayment('cash')">
            <div class="label">CASH</div>
            <div class="desc">Pay assistant</div>
          </div>
          <div class="payment-method" onclick="selectPayment('mobile')">
            <div class="label">MOBILE</div>
            <div class="desc">Scan QR code</div>
          </div>
        </div>
      </div>

      <button class="btn btn-dark btn-block btn-lg" onclick="processPayment()">
        Complete Payment
      </button>
      <button class="btn btn-light btn-block" onclick="backToCart()" style="margin-top: 15px;">
        Back to Cart
      </button>
    </div>
  </div>

  <!-- RECEIPT SCREEN -->
  <div id="receiptScreen" class="receipt-screen">
    <div class="receipt-box">
      <div class="receipt-paper" id="receiptPaper"></div>
      <div class="receipt-actions">
        <button class="btn btn-light" onclick="printReceipt()">Print Receipt</button>
        <button class="btn btn-dark" onclick="finishTransaction()">Done</button>
      </div>
    </div>
  </div>

  <script>
    // ========== STATE ==========
    let currentUser = null;
    let loginMode = 'customer';
    let products = [];
    let cart = [];
    let selectedCategory = 'All';
    let selectedPayment = 'card';
    let lastSale = null;

    // ========== API ==========
    const api = {
      get: async (url) => (await fetch('/api' + url)).json(),
      post: async (url, data) => {
        const res = await fetch('/api' + url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
        return res.json();
      },
      put: async (url, data) => {
        const res = await fetch('/api' + url, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
        return res.json();
      }
    };

    // ========== WELCOME SCREEN ==========
    function startGuest() {
      currentUser = { role: 'guest', name: 'Guest' };
      startKiosk();
    }

    function openLoginModal(mode) {
      loginMode = mode;
      document.getElementById('loginTitle').textContent = mode === 'admin' ? 'Staff Login' : 'Member Login';
      document.getElementById('registerLink').style.display = mode === 'admin' ? 'none' : 'block';
      document.getElementById('loginModal').classList.add('active');
    }

    function closeLoginModal() {
      document.getElementById('loginModal').classList.remove('active');
      document.getElementById('loginError').classList.add('hidden');
      document.getElementById('loginUsername').value = '';
      document.getElementById('loginPassword').value = '';
    }

    function showRegister() {
      closeLoginModal();
      document.getElementById('registerModal').classList.add('active');
    }

    function closeRegisterModal() {
      document.getElementById('registerModal').classList.remove('active');
    }

    function backToLogin() {
      closeRegisterModal();
      openLoginModal('customer');
    }

    async function handleLogin(e) {
      e.preventDefault();
      const result = await api.post('/login', {
        username: document.getElementById('loginUsername').value,
        password: document.getElementById('loginPassword').value
      });

      if (result.success) {
        currentUser = result.user;
        closeLoginModal();
        if (currentUser.role === 'admin') {
          startAdmin();
        } else {
          startKiosk();
        }
      } else {
        document.getElementById('loginError').textContent = result.error;
        document.getElementById('loginError').classList.remove('hidden');
      }
    }

    async function handleRegister(e) {
      e.preventDefault();
      const result = await api.post('/register', {
        name: document.getElementById('regName').value,
        email: document.getElementById('regEmail').value,
        username: document.getElementById('regUsername').value,
        password: document.getElementById('regPassword').value,
        phone: document.getElementById('regPhone').value
      });

      if (result.success) {
        currentUser = result.user;
        closeRegisterModal();
        startKiosk();
      } else {
        document.getElementById('registerError').textContent = result.error;
        document.getElementById('registerError').classList.remove('hidden');
      }
    }

    function logout() {
      currentUser = null;
      cart = [];
      document.getElementById('kioskApp').classList.remove('active');
      document.getElementById('adminApp').classList.remove('active');
      document.getElementById('welcomeScreen').style.display = 'flex';
    }

    // ========== KIOSK MODE ==========
    async function startKiosk() {
      document.getElementById('welcomeScreen').style.display = 'none';
      document.getElementById('kioskApp').classList.add('active');
      document.getElementById('userDisplay').textContent = currentUser.name + (currentUser.role === 'customer' ? ' (Member)' : '');
      
      products = await api.get('/products');
      renderCategories();
      renderProducts();
    }

    function renderCategories() {
      const cats = ['All', ...new Set(products.map(p => p.category))];
      document.getElementById('categoriesContainer').innerHTML = cats.map(c =>
        `<button class="category-btn ${c === selectedCategory ? 'active' : ''}" onclick="selectCategory('${c}')">${c}</button>`
      ).join('');
    }

    function selectCategory(cat) {
      selectedCategory = cat;
      renderCategories();
      renderProducts();
    }

    function renderProducts() {
      const search = document.getElementById('searchInput')?.value.toLowerCase() || '';
      const filtered = products.filter(p => {
        const matchCat = selectedCategory === 'All' || p.category === selectedCategory;
        const matchSearch = p.name.toLowerCase().includes(search) || p.barcode?.includes(search);
        return matchCat && matchSearch;
      });

      document.getElementById('productsGrid').innerHTML = filtered.map(p => `
        <div class="product-card ${p.stock <= 0 ? 'out-of-stock' : ''}" onclick="addToCart(${p.id})">
          <div class="category-tag">${p.category}</div>
          <div class="name">${p.name}</div>
          <div class="price">R${p.price.toFixed(2)}</div>
          <div class="stock">${p.stock > 0 ? `${p.stock} in stock` : 'Out of stock'}</div>
        </div>
      `).join('');
    }

    function filterProducts() {
      renderProducts();
    }

    // ========== CART ==========
    function addToCart(productId) {
      const product = products.find(p => p.id === productId);
      if (!product || product.stock <= 0) return;

      const existing = cart.find(c => c.productId === productId);
      if (existing) {
        if (existing.quantity >= product.stock) return alert('Not enough stock available');
        existing.quantity++;
      } else {
        cart.push({ productId, name: product.name, price: product.price, quantity: 1, maxStock: product.stock });
      }
      renderCart();
    }

    function updateQty(productId, delta) {
      const item = cart.find(c => c.productId === productId);
      if (!item) return;

      item.quantity += delta;
      if (item.quantity <= 0) {
        cart = cart.filter(c => c.productId !== productId);
      } else if (item.quantity > item.maxStock) {
        item.quantity = item.maxStock;
      }
      renderCart();
    }

    function removeItem(productId) {
      cart = cart.filter(c => c.productId !== productId);
      renderCart();
    }

    function clearCart() {
      cart = [];
      renderCart();
    }

    function renderCart() {
      const container = document.getElementById('cartItems');
      
      if (cart.length === 0) {
        container.innerHTML = `<div class="cart-empty"><p>Your cart is empty</p><p style="font-size: 13px;">Tap products to add them</p></div>`;
        document.getElementById('cartSubtotal').textContent = 'R0.00';
        document.getElementById('cartTax').textContent = 'R0.00';
        document.getElementById('cartTotal').textContent = 'R0.00';
        document.getElementById('checkoutBtn').disabled = true;
        return;
      }

      container.innerHTML = cart.map(item => `
        <div class="cart-item">
          <div class="cart-item-info">
            <div class="cart-item-name">${item.name}</div>
            <div class="cart-item-price">R${item.price.toFixed(2)} each</div>
          </div>
          <div class="cart-item-qty">
            <button class="qty-btn" onclick="updateQty(${item.productId}, -1)">-</button>
            <span class="qty-value">${item.quantity}</span>
            <button class="qty-btn" onclick="updateQty(${item.productId}, 1)">+</button>
          </div>
          <div class="cart-item-subtotal">R${(item.price * item.quantity).toFixed(2)}</div>
          <button class="cart-item-remove" onclick="removeItem(${item.productId})">x</button>
        </div>
      `).join('');

      const subtotal = cart.reduce((sum, i) => sum + i.price * i.quantity, 0);
      const tax = subtotal * 0.15;
      const total = subtotal + tax;

      document.getElementById('cartSubtotal').textContent = 'R' + subtotal.toFixed(2);
      document.getElementById('cartTax').textContent = 'R' + tax.toFixed(2);
      document.getElementById('cartTotal').textContent = 'R' + total.toFixed(2);
      document.getElementById('checkoutBtn').disabled = false;
    }

    // ========== CHECKOUT ==========
    function goToCheckout() {
      if (cart.length === 0) return;

      document.getElementById('checkoutItems').innerHTML = cart.map(item => `
        <div class="order-item">
          <span>${item.quantity}x ${item.name}</span>
          <span>R${(item.price * item.quantity).toFixed(2)}</span>
        </div>
      `).join('');

      const total = cart.reduce((sum, i) => sum + i.price * i.quantity, 0) * 1.15;
      document.getElementById('checkoutTotal').textContent = 'R' + total.toFixed(2);

      document.getElementById('checkoutScreen').classList.add('active');
    }

    function backToCart() {
      document.getElementById('checkoutScreen').classList.remove('active');
    }

    function selectPayment(method) {
      selectedPayment = method;
      document.querySelectorAll('.payment-method').forEach(el => el.classList.remove('selected'));
      event.target.closest('.payment-method').classList.add('selected');
    }

    async function processPayment() {
      const sale = await api.post('/sales', {
        items: cart.map(c => ({ productId: c.productId, quantity: c.quantity })),
        customerId: currentUser.customerId || null,
        paymentMethod: selectedPayment,
        isKiosk: true
      });

      lastSale = sale;
      document.getElementById('checkoutScreen').classList.remove('active');
      showReceipt(sale);
    }

    // ========== RECEIPT ==========
    function showReceipt(sale) {
      document.getElementById('receiptPaper').innerHTML = `
        <div class="receipt-header">
          <h2>Self-Service POS</h2>
          <div class="store-info">Your Neighbourhood Store</div>
          <div class="store-info">123 Main Street, Johannesburg</div>
          <div class="receipt-meta">
            <div>Receipt: ${sale.receiptNumber}</div>
            <div>${new Date(sale.timestamp).toLocaleString()}</div>
          </div>
        </div>
        <div class="receipt-items">
          ${sale.items.map(i => `
            <div class="receipt-item">
              <span>${i.quantity}x ${i.name}</span>
              <span>R${i.subtotal.toFixed(2)}</span>
            </div>
          `).join('')}
        </div>
        <div class="receipt-summary">
          <div class="receipt-row"><span>Subtotal:</span><span>R${sale.subtotal.toFixed(2)}</span></div>
          <div class="receipt-row"><span>VAT (15%):</span><span>R${sale.tax.toFixed(2)}</span></div>
          <div class="receipt-row total"><span>TOTAL:</span><span>R${sale.total.toFixed(2)}</span></div>
          <div class="receipt-row" style="margin-top: 10px;"><span>Paid by:</span><span>${sale.paymentMethod.toUpperCase()}</span></div>
        </div>
        <div class="receipt-footer">
          <div>Customer: ${sale.customerName}</div>
          <div style="margin-top: 15px;">Thank you for shopping with us!</div>
          <div>Please take your receipt</div>
        </div>
      `;
      document.getElementById('receiptScreen').classList.add('active');
    }

    function printReceipt() {
      window.print();
    }

    async function finishTransaction() {
      document.getElementById('receiptScreen').classList.remove('active');
      cart = [];
      renderCart();
      products = await api.get('/products');
      renderProducts();
    }

    // ========== ADMIN MODE ==========
    async function startAdmin() {
      document.getElementById('welcomeScreen').style.display = 'none';
      document.getElementById('adminApp').classList.add('active');
      document.getElementById('adminUserDisplay').textContent = currentUser.name;
      showAdminTab('dashboard');
    }

    async function showAdminTab(tab) {
      document.querySelectorAll('#adminNav button').forEach(b => b.classList.remove('active'));
      event?.target?.classList.add('active');

      const content = document.getElementById('adminContent');

      if (tab === 'dashboard') {
        const stats = await api.get('/stats');
        content.innerHTML = `
          <h2 style="margin-bottom: 20px;">Store Overview</h2>
          <div class="stats-grid">
            <div class="stat-box"><div class="value">R${stats.todaySales}</div><div class="label">Today's Sales</div></div>
            <div class="stat-box"><div class="value">${stats.todayTransactions}</div><div class="label">Transactions</div></div>
            <div class="stat-box"><div class="value">${stats.totalProducts}</div><div class="label">Products</div></div>
            <div class="stat-box"><div class="value">${stats.lowStockItems}</div><div class="label">Low Stock</div></div>
            <div class="stat-box"><div class="value">${stats.totalCustomers}</div><div class="label">Customers</div></div>
          </div>
        `;
      } else if (tab === 'sales') {
        const sales = await api.get('/sales');
        content.innerHTML = `
          <h2 style="margin-bottom: 20px;">Sales History</h2>
          <table class="data-table">
            <thead><tr><th>Receipt</th><th>Customer</th><th>Items</th><th>Total</th><th>Payment</th><th>Date</th></tr></thead>
            <tbody>
              ${sales.map(s => `
                <tr>
                  <td><strong>${s.receiptNumber}</strong></td>
                  <td>${s.customerName}</td>
                  <td>${s.items.length} items</td>
                  <td><strong>R${s.total.toFixed(2)}</strong></td>
                  <td>${s.paymentMethod}</td>
                  <td>${new Date(s.timestamp).toLocaleString()}</td>
                </tr>
              `).join('') || '<tr><td colspan="6" style="text-align:center;color:#888;">No sales yet</td></tr>'}
            </tbody>
          </table>
        `;
      } else if (tab === 'products') {
        const prods = await api.get('/products');
        content.innerHTML = `
          <h2 style="margin-bottom: 20px;">Product Inventory</h2>
          <table class="data-table">
            <thead><tr><th>Product</th><th>Category</th><th>Price</th><th>Stock</th><th>Barcode</th></tr></thead>
            <tbody>
              ${prods.map(p => `
                <tr>
                  <td><strong>${p.name}</strong></td>
                  <td>${p.category}</td>
                  <td>R${p.price.toFixed(2)}</td>
                  <td>${p.stock}</td>
                  <td>${p.barcode || '-'}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      } else if (tab === 'customers') {
        const custs = await api.get('/customers');
        content.innerHTML = `
          <h2 style="margin-bottom: 20px;">Customer List</h2>
          <table class="data-table">
            <thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Loyalty Points</th><th>Member Since</th></tr></thead>
            <tbody>
              ${custs.map(c => `
                <tr>
                  <td><strong>${c.name}</strong></td>
                  <td>${c.email}</td>
                  <td>${c.phone}</td>
                  <td>${c.loyaltyPoints} pts</td>
                  <td>${c.memberSince}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      }
    }
  </script>
</body>
</html>
